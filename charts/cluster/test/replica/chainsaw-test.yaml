##
# This test sets up a CNPG cluster with MinIO backups and then restores the cluster from the backup using backup,
# object store, and object store with PITR replica.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: replica
spec:
  timeouts:
    apply: 1s
    assert: 2m
    cleanup: 1m
  steps:
    - name: Clear the MinIO bucket
      try:
        - apply:
            file: ./00-minio_cleanup.yaml
        - assert:
            file: ./00-minio_cleanup-assert.yaml
      catch:
        - describe:
            apiVersion: batch/v1
            kind: Job
        - podLogs:
            selector: batch.kubernetes.io/job-name=minio_cleanup
    - name: Install a source cluster
      try:
        - script:
            content: |
              kubectl -n $NAMESPACE create secret generic kube-root-ca.crt --from-literal=ca.crt="$(kubectl -n kube-system get configmaps kube-root-ca.crt -o jsonpath='{.data.ca\.crt}')" --dry-run=client -o yaml | kubectl apply -f -
              helm upgrade \
                --install \
                --namespace $NAMESPACE \
                --values ./01-source_cluster.yaml \
                --wait \
                source ../../
        - assert:
            file: 01-source_cluster-assert.yaml
      catch:
        - describe:
            apiVersion: postgresql.cnpg.io/v1
            kind: Cluster
    - name: Write some data to the cluster
      try:
        - apply:
            file: ./02-data_write.yaml
        - assert:
            file: ./02-data_write-assert.yaml
      catch:
        - describe:
            apiVersion: batch/v1
            kind: Job
        - podLogs:
            selector: batch.kubernetes.io/job-name=data-write
    - name: Create a backup
      try:
        - apply:
            file: ./03-checkpoint.yaml
    - name: Create a replica cluster from pg_basebackup
      try:
        - script:
            content: |
              helm upgrade \
                --install \
                --namespace $NAMESPACE \
                --values ./05-replica_cluster.yaml \
                --wait \
                replica ../../
        - assert:
            file: ./05-replica_cluster-assert.yaml
    - name: Verify the data on the replica cluster exists
      try:
        - apply:
            file: 06-data_test.yaml
        - assert:
            file: 06-data_test-assert.yaml
    - name: Create a replica cluster from object store
      try:
        - script:
            content: |
              helm upgrade \
                --install \
                --namespace $NAMESPACE \
                --values ./07-replica_object_store_cluster.yaml \
                --wait \
                replica-object-store ../../
        - assert:
            file: ./07-replica_object_store_cluster-assert.yaml
    - name: Verify the data on the object store replica cluster exists
      try:
        - apply:
            file: 08-data_test.yaml
        - assert:
            file: 08-data_test-assert.yaml
    - name: Cleanup
      try:
        - script:
            content: |
              helm uninstall --namespace $NAMESPACE source
              helm uninstall --namespace $NAMESPACE replica
              helm uninstall --namespace $NAMESPACE replica-object-store
